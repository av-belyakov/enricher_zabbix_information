# Enricher_Zabbix_information

[![Go Version](https://img.shields.io/badge/Go-1.25.6+-00ADD8?style=flat&logo=go)](https://golang.org/)
[![Docker](https://img.shields.io/badge/Docker-Ready-2496ED?style=flat&logo=docker)](https://www.docker.com/)

Сервис 'Enricher_Zabbix_information' выполняет изменение или обогащение информации хранящейся в Zabbix. Информация, необходимая для обогащения данных Zabbix, запрашивается из Netbox.

## Подробное описание работы сервиса

После старта, сервис 'Enricher\*Zabbix_information' разворачивает простой http сервер по адресу и порту взятым из полей **InformationServerApi.host** и **InformationServerApi.port**. В нём можно посмотреть статистику и логи сервиса и запустить выполнения задачи в "ручном режиме", но это скорее исключительный случай.

Для запуска выполнения задачи в "ручном режиме" нужно перейти по адресу http://any-host:any-port/manually*task_starting и ввести в поле ввода токен. Токен находится а http://gitlab.cloud.gcm/a.belyakov/enricher_zabbix_information/-/settings/ci_cd в пункте \_Variables* под именем **GO_ENRICHERZI_APISERVERTOKEN**.

Основной режим работы сервиса, это запуск задач в автоматическом режиме, его настройка задаётся в конфигурационном файле - значения **Schedule.dailyJob** (далее - Время запуска) или **Schedule.timerJob** (далее - Интервал запуска). При этом "Время запуска" приоритетнее чем "Интервал запуска". Если заданны обе эти величины, то "Интервал запуска" игнорируется.

При наступлении заданного времени или интервала, если время запуска не задано или инициализация выполнениязадачи через веб-приложение начинается выполнения задачи состоящей из следующих шагов:

1. Запрос из Zabbix полного списка групп хостов;
2. Обработка списка id хостов, относящихся к группам веб-сайтов мониторинга. Данный список хранится в файле **config/dictionary.yml**, список **dictionaries.websites_group_monitoring**. На основании этого списка выполняется фильтрация групп хостов, те группы хостов которые не совпадают с этим списком не будут учитыватся в дальнейшей обработке. Если список **dictionaries.websites_group_monitoring** пуст, то обрабатываются все группы хостов;
3. Запрос списка хостов полученых на основе групп, которые есть в файле **config/dictionary.yml**, список **dictionaries.websites_group_monitoring**. Или всех хостов, если список **dictionaries.websites_group_monitoring** в файле **config/dictionary.yml** пуст;
4. Инициализация преобразования доменных имен, из списка хостов, в ip адреса;
5. Запрос списка всех префиксов (подсетей) в Netbox в разделе **IPAM/Префиксы** или по URL **http://netbox.any:8005/ipam/prefixes/**;
6. Поиск ip адресов из списка хостов в перфиксах полученных от Netbox. Если ip адрес входит в искомый диапазон, то информация о нём сохраняется. В том числе такие настраеваемые поля как номер СОА;
7. Добавляем или обновляем теги в списке хостов Zabbix.

В результате будет выполнена актулизация списка хостов Zabbix, где будут обновлены теги содержащие информаци о номере СОА. Если тег уже установлен в Zabbix и имеет тоже имя что и тег полученный в результате работы сервиса, то значение этого тега будет заменено новым значением.

## Конфигурационные настройки

Конфигурационные параметры для этого сервиса, могут быть заданы как через конфигурационный файл, так и методом установки переменных окружения. Однако, все пароли и ключевые токены, используемые для авторизации, задаются ТОЛЬКО через переменные окружения.

### Типы конфигурационных файлов:

- _config.yml_ это общий конфигурационный файл, здесь хранятся настройки логирования и другие общие, не зависящие от режима выполнения приложения, данные;
- _config_test.yml_ это конфигурационный файл который используется для юнит тестов функций и методов или развёртывания совсем 'сырого' приложения;
- _config_dev.yml_ это конфигурационный файл, используемый при развертывании тестовой инфраструктуры, максимально приближенной к продуктовой;
- _config_prod.yml_ это конфигурационный файл, применяемый в продуктовом режиме.

Основная переменная окружения для данного приложения - **GO_ENRICHERZI_MAIN**. На основании значения этой переменной принимается решение какой из конфигурационных файлов _config_dev.yml_ или _config_prod.yml_ использовать. При **GO_ENRICHERZI_MAIN=development** будет использоваться _config_dev.yml_, при **GO_ENRICHERZI_MAIN=test** будет использоваться _config_test.yml_ соответственно. Во всех остальных случаях, в том числе и при отсутствии переменной окружения **GO_ENRICHERZI_MAIN** будет использоваться конфигурационный файл _config_prod.yml_. Перечень переменных окружения которые можно использовать для настройки приложения:

### Переменная окружения отвечающая за тип запуска приложения "development", "test" или "production"

- 'GO_ENRICHERZI_MAIN'

#### Переменные окружения отвечающие за ограничение доступа

- 'GO_ENRICHERZI_ZPASSWD' - пароль для доступа к Zabbix
- 'GO_ENRICHERZI_NBTOKEN' - пароль для доступа к NetBox
- 'GO_ENRICHERZI_DBWLOGPASSWD' - пароль для доступа к БД логирования
- 'GO_ENRICHERZI_APISERVERTOKEN' - токен доступа из веб-интерфейса

#### Переменные окружения отвечающие за доступ к Zabbix

- 'GO_ENRICHERZI_ZHOST' - доменное имя или ip
- 'GO_ENRICHERZI_ZPORT' - сетевой порт
- 'GO_ENRICHERZI_ZUSER' - имя пользователя для авторизации

#### Переменные окружения отвечающие за доступ к NetBox

- 'GO_ENRICHERZI_NBHOST' - доменное имя или ip
- 'GO_ENRICHERZI_NBPORT' - сетевой порт
- 'GO_ENRICHERZI_NBUSER' - имя пользователя для авторизации

#### Переменные окружения отвечающие за настройки доступа к InformationServerApi

- 'GO_ENRICHERZI_APIISHOST' - доменное имя или ip
- 'GO_ENRICHERZI_APIISPORT' - сетевой порт

#### Переменные окружения отвечающие за настройку доступа к БД применяемой для хранения логов

- 'GO_ENRICHERZI_DBWLOGHOST' - доменное имя или ip
- 'GO_ENRICHERZI_DBWLOGPORT' - сетевой порт
- 'GO_ENRICHERZI_DBWLOGNAME' - наименование БД (при необходимости)
- 'GO_ENRICHERZI_DBWLOGUSER' - пользователь
- 'GO_ENRICHERZI_DBWLOGSTORAGENAME' - наименование объекта хранения логов (таблица, документ, индекс и т.д. зависит от типа БД)

Настройки логирования данных в БД не являются обязательными и необходимы только если пользователь приложения желает хранить логи в базе данных.

Приоритет значений заданных через переменные окружения выше чем значений полученных из конфигурационных файлов. Таким образом можно осуществлять гибкую временную настройку приложения.

### Расписание выполнения задачи.

Выполнять задачу, сервис, может как с заданной периодичностью, так и по указанному, в виде списка времени, расписанию в формате HH:MM:SS. Диапазон времени расписания составляет одни сутки.

- _timerJob_ частота запуска задачи в минутах
- _dailyJob_ время запуска задачи в формате HH:MM:SS

При этом, если указаны оба параметра, то предпочтение отдаётся расписанию времени запуска. Если оба параметры пусты, то задача будет запускаться с периодичностью в 60 минут.
